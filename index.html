<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yapper</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        :root {
            --imessage-blue: linear-gradient(180deg, #00D2FF 0%, #007AFF 100%);
            --bg-main: #ffffff;
            --text-dark: #000000;
            --text-gray: #8E8E93;
            --bubble-received: #E9E9EB;
            --border: #C6C6C8;
            --ios-green: #34C759;
            --ios-font: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
        }
        [data-theme="dark"] {
            --bg-main: #000000; --text-dark: #ffffff; --text-gray: #98989D;
            --bubble-received: #1C1C1E; --border: #38383A;
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; transition: background-color 0.3s; }
        body, html { margin: 0; padding: 0; height: 100dvh; font-family: var(--ios-font); background: var(--bg-main); color: var(--text-dark); overflow: hidden; }
        .view { display: none; flex-direction: column; height: 100%; width: 100%; }
        .header { padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; background: var(--bg-main); opacity: 0.98; backdrop-filter: blur(25px); border-bottom: 0.5px solid var(--border); height: 64px; z-index: 10; }
        .avatar-container { position: relative; width: 40px; height: 40px; }
        .avatar { width: 100%; height: 100%; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .status-dot { position: absolute; bottom: 1px; right: 1px; width: 10px; height: 10px; border-radius: 50%; background: var(--ios-green); border: 2px solid var(--bg-main); display: none; }
        .status-dot.active { display: block; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 4px; }
        .msg-container { display: flex; flex-direction: column; margin-bottom: 2px; position: relative; }
        .msg-container.sent { align-items: flex-end; }
        .msg-container.received { align-items: flex-start; }
        .msg { max-width: 75%; padding: 10px 16px; font-size: 16px; border-radius: 20px; line-height: 1.3; cursor: pointer; }
        .sent .msg { background: var(--imessage-blue); color: white; border-bottom-right-radius: 4px; }
        .received .msg { background: var(--bubble-received); color: var(--text-dark); border-bottom-left-radius: 4px; }
        .msg-label { font-size: 11px; color: var(--text-gray); margin: 2px 5px; display: none; font-weight: 500; }
        .show-label { display: block; }
        .reaction-badge { position: absolute; bottom: -8px; right: 10px; background: white; border-radius: 12px; padding: 1px 5px; font-size: 13px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 0.5px solid #eee; color: #000; }
        #reaction-menu { position: fixed; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); border-radius: 30px; padding: 8px 15px; display: none; gap: 12px; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .compose-bar { padding: 10px 12px 34px 12px; display: flex; align-items: center; gap: 10px; border-top: 0.5px solid var(--border); }
        .input-wrapper { flex: 1; border: 0.5px solid var(--border); border-radius: 25px; padding: 7px 15px; }
        .msg-input { width: 100%; border: none; background: transparent; outline: none; font-size: 16px; color: var(--text-dark); }
        .send-btn { width: 32px; height: 32px; background: #007AFF; border: none; border-radius: 50%; color: white; font-size: 18px; }
    </style>
</head>
<body data-theme="light">
    <div id="reaction-menu">
        <span onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span><span onclick="sendReaction('üòÇ')">üòÇ</span><span onclick="sendReaction('üëç')">üëç</span>
    </div>
    <div id="auth-view" class="view" style="display:flex; justify-content:center; align-items:center;">
        <div style="text-align:center; width:80%;">
            <h1 style="font-size:42px; letter-spacing:-2px; margin-bottom:40px;">Yapper</h1>
            <input type="email" id="email" placeholder="Email" style="width:100%; padding:15px; border-radius:12px; border:1px solid var(--border); margin-bottom:10px;">
            <input type="password" id="password" placeholder="Password" style="width:100%; padding:15px; border-radius:12px; border:1px solid var(--border); margin-bottom:20px;">
            <button id="btn-login" style="width:100%; background:#007AFF; color:white; padding:15px; border-radius:12px; border:none; font-weight:bold;">Log In</button>
        </div>
    </div>
    <div id="home-view" class="view">
        <div class="header">
            <button onclick="toggleDarkMode()" style="background:none; border:none; font-size:20px;">üåì</button>
            <div style="font-weight:700; font-size:22px;">Messages</div>
            <button id="btn-logout" style="background:none; border:none; color:#007AFF; font-size:17px;">Exit</button>
        </div>
        <div id="friend-list"></div>
    </div>
    <div id="chat-view" class="view">
        <div class="header">
            <button id="btn-back" style="background:none; border:none; color:#007AFF; font-size:17px;">‚Äπ Back</button>
            <div style="text-align:center;"><div id="chat-target-name" style="font-weight:600;">Contact</div><div id="chat-status" style="font-size:11px; color:var(--text-gray);">Offline</div></div>
            <div style="width:40px"></div>
        </div>
        <div id="messages" onclick="document.getElementById('reaction-menu').style.display='none'"></div>
        <div class="compose-bar">
            <div class="input-wrapper"><input type="text" id="msg-input" class="msg-input" placeholder="iMessage"></div>
            <button id="btn-send" class="send-btn">‚Üë</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, doc, updateDoc, onSnapshot, collection, query, orderBy, addDoc, serverTimestamp, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyB98LWEjfYaG_wbkMkwo0QJ4ch8VhQO-IA", authDomain: "messengerapp-dcccc.firebaseapp.com", projectId: "messengerapp-dcccc", storageBucket: "messengerapp-dcccc.firebasestorage.app", messagingSenderId: "255835922798", appId: "1:255835922798:web:d9293fc275ae2b18fa617f" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);
        let activeChatId = null;

        window.toggleDarkMode = () => { const t = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light'; document.body.setAttribute('data-theme', t); localStorage.setItem('theme', t); };
        document.body.setAttribute('data-theme', localStorage.getItem('theme') || 'light');

        onAuthStateChanged(auth, async user => {
            if (user) { switchView('home-view'); updateDoc(doc(db, "users", user.uid), { status: 'online' }); loadFriends(); }
            else { switchView('auth-view'); }
        });

        function loadFriends() {
            onSnapshot(collection(db, "users", auth.currentUser.uid, "friends"), snap => {
                const list = document.getElementById('friend-list'); list.innerHTML = '';
                snap.forEach(d => {
                    onSnapshot(doc(db, "users", d.data().uid), fSnap => {
                        const f = fSnap.data();
                        let row = document.getElementById(`f-${d.data().uid}`) || document.createElement('div');
                        row.id = `f-${d.data().uid}`; row.className = 'friend-item'; row.style="padding:15px; display:flex; align-items:center; gap:12px; border-bottom:0.5px solid var(--border); cursor:pointer;";
                        row.innerHTML = `<div class="avatar-container"><div class="avatar">üë§</div><div class="status-dot ${f.status==='online'?'active':''}"></div></div><div><div style="font-weight:600;">${f.nickname}</div><div style="font-size:13px; color:var(--text-gray);">${f.status==='online'?'Active now':'Offline'}</div></div>`;
                        row.onclick = () => openChat(f, [auth.currentUser.uid, fSnap.id].sort().join('_'));
                        list.appendChild(row);
                    });
                });
            });
        }

        function openChat(friend, roomId) {
            activeChatId = roomId; switchView('chat-view');
            document.getElementById('chat-target-name').innerText = friend.nickname;
            onSnapshot(query(collection(db, "chats", roomId, "messages"), orderBy("timestamp", "asc")), snap => {
                const div = document.getElementById('messages'); div.innerHTML = '';
                snap.forEach(mD => {
                    const m = mD.data(); const isSent = m.sender === auth.currentUser.uid;
                    const c = document.createElement('div'); c.className = `msg-container ${isSent?'sent':'received'}`;
                    c.innerHTML = `<div class="msg" onclick="this.nextSibling.classList.toggle('show-label')">${m.text}</div><div class="msg-label">${m.timestamp?'Delivered':''}</div>${m.reaction?`<div class="reaction-badge">${m.reaction}</div>`:''}`;
                    div.appendChild(c);
                });
                div.scrollTop = div.scrollHeight;
            });
        }

        document.getElementById('btn-send').onclick = () => {
            const i = document.getElementById('msg-input');
            if (i.value.trim()) { addDoc(collection(db, "chats", activeChatId, "messages"), { text: i.value, sender: auth.currentUser.uid, timestamp: serverTimestamp() }); i.value=''; }
        };

        function switchView(id) { document.querySelectorAll('.view').forEach(v=>v.style.display='none'); document.getElementById(id).style.display='flex'; }
        document.getElementById('btn-login').onclick = () => signInWithEmailAndPassword(auth, email.value, password.value);
        document.getElementById('btn-logout').onclick = () => signOut(auth);
    </script>
</body>
</html>
